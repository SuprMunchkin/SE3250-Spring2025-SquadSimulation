<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Monte Carlo Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        #mc-form {
            display: inline-block;
            text-align: center;
            margin-bottom: 24px;
        }
        .form-group {
            margin-bottom: 18px;
            text-align: center;
        }
        .form-group label,
        .form-group input,
        .form-group select {
            display: block;
            margin: 0 auto;
        }
        #histogram, #exhaustion-histogram, #distance-histogram {
            margin: 20px auto;
            display: block;
        }
    </style>
</head>
<body>
    <h1>Monte Carlo Simulation</h1>
    <form id="mc-form">
        <div class="form-group">
            <label for="num_runs">Number of Runs:</label>
            <input type="number" id="num_runs" name="num_runs" value="100" min="1" max="10000">
            <br>
            <label for="blue_stock">Blue Stock:</label>
            <input type="number" id="blue_stock" name="blue_stock" value="10" min="1" max="20">
            <br>
            <label for="red_stock">Red Stock:</label>
            <input type="number" id="red_stock" name="red_stock" value="10" min="1" max="40">
            <br>
            <label for="direction_deviation">Direction Deviation:</label>
            <input type="number" id="direction_deviation" name="direction_deviation" value="10" min="0" max="45" step="5">
        </div>
        <div class="form-group">
            <label for="armor_type">Armor Type:</label>
            <select id="armor_type" name="armor_type">
                <option value="Basilone Ballistic Insert">Basilone Ballistic Insert</option>
                <option value="Chesty Ballistic Insert">Chesty Ballistic Insert</option>
                <option value="Hathcock Ballistic Insert">Hathcock Ballistic Insert</option>
            </select>
            <br>
            <label for="environment">Environment:</label>
            <select id="environment" name="environment">
                <option value="Krulak’s Three Block War">Krulak’s Three Block War</option>
                <option value="Pershing’s Ghost">Pershing’s Ghost</option>
                <option value="Nightmare from Mattis Street">Nightmare from Mattis Street</option>
            </select>
        </div>
        <div class="form-group">
            <button type="submit">Run Monte Carlo</button>
            <button type="button" id="clear-btn">Clear</button>
        </div>
    </form>
    <div id="results"></div>
    <canvas id="histogram" width="600" height="300"></canvas>
    <canvas id="exhaustion-histogram" width="600" height="300"></canvas>
    <canvas id="distance-histogram" width="600" height="300"></canvas>
    <script>
        let chart = null;
        let exhaustionChart = null;
        let distanceChart = null;
        document.getElementById('mc-form').onsubmit = async function(e) {
            e.preventDefault();
            // Clear previous output immediately
            document.getElementById('results').innerHTML = '';
            const ctx = document.getElementById('histogram').getContext('2d');
            const exhaustionCtx = document.getElementById('exhaustion-histogram').getContext('2d');
            const distanceCtx = document.getElementById('distance-histogram').getContext('2d');
            if (chart) { chart.destroy(); chart = null; }
            ctx.clearRect(0, 0, 600, 300);
            if (exhaustionChart) { exhaustionChart.destroy(); exhaustionChart = null; }
            exhaustionCtx.clearRect(0, 0, 600, 300);
            if (distanceChart) { distanceChart.destroy(); distanceChart = null; }
            distanceCtx.clearRect(0, 0, 600, 300);

            const params = new URLSearchParams(new FormData(this));
            const res = await fetch('/run_monte_carlo?' + params);
            const data = await res.json();
            document.getElementById('results').innerHTML = `
                <h2>Results</h2>
                <p>Number of Runs: ${data.num_runs}</p>
                <p>Average Score: ${data.avg_score}</p>
            `;

            // Score histogram (existing)
            const scores = data.all_results.map(r => r.score || 0);
            const binCount = 10;
            const min = Math.min(...scores);
            const max = Math.max(...scores);
            const binSize = (max - min) / binCount || 1;
            const bins = Array(binCount).fill(0);
            scores.forEach(score => {
                let idx = Math.floor((score - min) / binSize);
                if (idx >= binCount) idx = binCount - 1;
                bins[idx]++;
            });
            const labels = [];
            for (let i = 0; i < binCount; i++) {
                const rangeStart = (min + i * binSize).toFixed(2);
                const rangeEnd = (min + (i + 1) * binSize).toFixed(2);
                labels.push(`${rangeStart} - ${rangeEnd}`);
            }
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Score Distribution',
                        data: bins,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)'
                    }]
                },
                options: {
                    scales: {
                        x: { title: { display: true, text: 'Score Range' } },
                        y: { title: { display: true, text: 'Frequency' }, beginAtZero: true }
                    }
                }
            });

            // Exhaustion histogram (existing)
            const exhaustionLevels = data.all_results.map(r => r.squad_exhaustion ?? 0);
            const exMin = Math.min(...exhaustionLevels);
            const exMax = Math.max(...exhaustionLevels);
            const exBinSize = (exMax - exMin) / binCount || 1;
            const exBins = Array(binCount).fill(0);
            exhaustionLevels.forEach(val => {
                let idx = Math.floor((val - exMin) / exBinSize);
                if (idx >= binCount) idx = binCount - 1;
                exBins[idx]++;
            });
            const exLabels = [];
            for (let i = 0; i < binCount; i++) {
                const rangeStart = (exMin + i * exBinSize).toFixed(2);
                const rangeEnd = (exMin + (i + 1) * exBinSize).toFixed(2);
                exLabels.push(`${rangeStart} - ${rangeEnd}`);
            }
            exhaustionChart = new Chart(exhaustionCtx, {
                type: 'bar',
                data: {
                    labels: exLabels,
                    datasets: [{
                        label: 'Squad Exhaustion Level Distribution',
                        data: exBins,
                        backgroundColor: 'rgba(255, 99, 132, 0.6)'
                    }]
                },
                options: {
                    scales: {
                        x: { title: { display: true, text: 'Exhaustion Level Range' } },
                        y: { title: { display: true, text: 'Frequency' }, beginAtZero: true }
                    }
                }
            });

            // Distance traveled histogram (NEW)
            const distances = data.all_results.map(r => r.distance_traveled ?? 0);
            const dMin = Math.min(...distances);
            const dMax = Math.max(...distances);
            const dBinSize = (dMax - dMin) / binCount || 1;
            const dBins = Array(binCount).fill(0);
            distances.forEach(val => {
                let idx = Math.floor((val - dMin) / dBinSize);
                if (idx >= binCount) idx = binCount - 1;
                dBins[idx]++;
            });
            const dLabels = [];
            for (let i = 0; i < binCount; i++) {
                const rangeStart = (dMin + i * dBinSize).toFixed(2);
                const rangeEnd = (dMin + (i + 1) * dBinSize).toFixed(2);
                dLabels.push(`${rangeStart} - ${rangeEnd}`);
            }
            distanceChart = new Chart(distanceCtx, {
                type: 'bar',
                data: {
                    labels: dLabels,
                    datasets: [{
                        label: 'Distance Traveled Distribution',
                        data: dBins,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)'
                    }]
                },
                options: {
                    scales: {
                        x: { title: { display: true, text: 'Distance Range' } },
                        y: { title: { display: true, text: 'Frequency' }, beginAtZero: true }
                    }
                }
            });
        };

        document.getElementById('clear-btn').onclick = function() {
            document.getElementById('results').innerHTML = '';
            const ctx = document.getElementById('histogram').getContext('2d');
            if (chart) { chart.destroy(); chart = null; }
            ctx.clearRect(0, 0, 600, 300);
            const exhaustionCtx = document.getElementById('exhaustion-histogram').getContext('2d');
            if (exhaustionChart) { exhaustionChart.destroy(); exhaustionChart = null; }
            exhaustionCtx.clearRect(0, 0, 600, 300);
            const distanceCtx = document.getElementById('distance-histogram').getContext('2d');
            if (distanceChart) { distanceChart.destroy(); distanceChart = null; }
            distanceCtx.clearRect(0, 0, 600, 300);
        };
    </script>
</body>
</html>